name: Deploy SSIS Project and Schedule Job

on:
  workflow_dispatch:

jobs:
  deploy-ssis-project:
    runs-on: [self-hosted, windows]

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy SSIS Project (.ispac)
        env:
          SQL_SERVER: ${{ secrets.SQL_SERVER }}
        shell: powershell
        run: |
          echo "Deploying SSIS project..."
          $ispacPath = "Database/bin/Development/Integration Services Project1.ispac"
          if (!(Test-Path $ispacPath)) {
            Write-Error "ISPAC file not found at $ispacPath"
            exit 1
          }

          $deployArgs = @(
            "/Silent",
            "/SourcePath:`"$ispacPath`"",
            "/DestinationServer:`"$env:SQL_SERVER`"",
            "/DestinationPath:""/SSISDB/MySSISPackages/Integration Services Project1"""
          )

          $process = Start-Process `
            -FilePath "C:\Program Files (x86)\Microsoft SQL Server\160\DTS\Binn\ISDeploymentWizard.exe" `
            -ArgumentList $deployArgs `
            -Wait `
            -PassThru `
            -NoNewWindow

          if ($process.ExitCode -ne 0) {
            Write-Error "Deployment failed with exit code $($process.ExitCode)"
            exit $process.ExitCode
          }

          echo "SSIS project deployed successfully."

      - name: Create SQL Agent Job with Schedule
        env:
          SQL_SERVER: ${{ secrets.SQL_SERVER }}
        shell: powershell
        run: |
          echo "Creating SQL Server Agent Job..."

          $jobScript = "
          USE msdb;

          -- Delete job if it exists
          IF EXISTS (SELECT * FROM msdb.dbo.sysjobs WHERE name = 'RunSSIS_IntegrationProject1')
          BEGIN
              EXEC msdb.dbo.sp_delete_job @job_name='RunSSIS_IntegrationProject1';
          END;

          -- Create job
          EXEC msdb.dbo.sp_add_job
              @job_name = 'RunSSIS_IntegrationProject1',
              @enabled = 1;

          -- Add job step to run SSIS package
          EXEC msdb.dbo.sp_add_jobstep
              @job_name = 'RunSSIS_IntegrationProject1',
              @step_name = 'Run SSIS Package',
              @subsystem = 'SSIS',
              @command = '/ISSERVER ""SSISDB\\MySSISPackages\\Integration Services Project1\\Package.dtsx"" /SERVER ""$env:SQL_SERVER""',
              @on_success_action = 1;

          -- Add job schedule (daily at 2:00 AM)
          DECLARE @schedule_id INT;
          EXEC msdb.dbo.sp_add_schedule
              @schedule_name = 'Daily2AM',
              @enabled = 1,
              @freq_type = 4, -- daily
              @freq_interval = 1,
              @active_start_time = 020000, -- 2:00 AM
              @schedule_id = @schedule_id OUTPUT;

          -- Attach schedule to job
          EXEC msdb.dbo.sp_attach_schedule
              @job_name = 'RunSSIS_IntegrationProject1',
              @schedule_name = 'Daily2AM';

          -- Assign job to server
          EXEC msdb.dbo.sp_add_jobserver
              @job_name = 'RunSSIS_IntegrationProject1';
          "

          Invoke-Sqlcmd -ServerInstance $env:SQL_SERVER -Query $jobScript
          echo "SQL Agent Job and schedule created successfully."
